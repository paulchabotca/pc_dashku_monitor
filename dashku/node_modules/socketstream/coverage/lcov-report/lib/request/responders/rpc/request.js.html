<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/request/responders/rpc/request.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../../../prettify.css">
    <link rel="stylesheet" href="../../../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">lib/request/responders/rpc/request.js</span></h1>
    <h2>
        Statements: <span class="metric">14.29% <small>(9 / 63)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">0% <small>(0 / 33)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">12.5% <small>(1 / 8)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">14.29% <small>(9 / 63)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">lib/request/responders/rpc/</a> &#187; request.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// RPC Server-side Request Handler
// -------------------------------
// The RPC handler is only interested in receiving a req object and calling back the res function with (err, response)
// It does not care HOW this request handler is accessed, how to serialize incoming/outgoing messages,
// or how to report errors - that's the job of the interface
&nbsp;
'use strict';
&nbsp;
&nbsp;
var apiTree, getBranchFromTree, pathlib;
&nbsp;
pathlib = require('path');
&nbsp;
apiTree = require('apitree');
&nbsp;
module.exports = function(ss, middleware) {
  var api, dir, request;
  dir = pathlib.join(ss.root, 'server/rpc');
  api = apiTree.createApiTree(dir);
  return (request = <span class="fstat-no" title="function not covered" >function(req, res) {</span>
<span class="cstat-no" title="statement not covered" >    var actions, cb, exec, file, main, methodAry, methodName, stack;</span>
&nbsp;
    // Initial error checking    
<span class="cstat-no" title="statement not covered" >    if (!(req.method &amp;&amp; typeof req.method === 'string' &amp;&amp; req.method.indexOf('.') &gt; 0)) {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('No action provided. Action names must be a string separated by dots/periods (e.g. \'message.send\')');</span>
    }
<span class="cstat-no" title="statement not covered" >    if (!(req.params &amp;&amp; req.params instanceof Array)) {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('Params must be supplied as an Array');</span>
    }
&nbsp;
    // Init request stack    
<span class="cstat-no" title="statement not covered" >    stack = [];</span>
&nbsp;
    // Allow middleware to be defined    
<span class="cstat-no" title="statement not covered" >    req.use = <span class="fstat-no" title="function not covered" >function(nameOrModule) {</span></span>
<span class="cstat-no" title="statement not covered" >      var args, fn, middlewareAry, mw;</span>
<span class="cstat-no" title="statement not covered" >      try {</span>
<span class="cstat-no" title="statement not covered" >        args = Array.prototype.slice.call(arguments);</span>
<span class="cstat-no" title="statement not covered" >        mw = typeof nameOrModule === 'function' ? nameOrModule :</span>
            (middlewareAry = nameOrModule.split('.'), getBranchFromTree(middleware, middlewareAry));
<span class="cstat-no" title="statement not covered" >        if (mw) {</span>
<span class="cstat-no" title="statement not covered" >          fn = mw.apply(mw, args.splice(1));</span>
<span class="cstat-no" title="statement not covered" >          return stack.push(fn);</span>
        } else {
<span class="cstat-no" title="statement not covered" >          throw new Error('Middleware function \'' + nameOrModule + '\' not found. Please reference internal or'+</span>
                        ' custom middleware as a string (e.g. \'session\' or \'user.checkAuthenticated\') or pass a function/module');
        }
      } catch (e) {
<span class="cstat-no" title="statement not covered" >        return res(e, null);</span>
      }
    };
&nbsp;
    // Separate the method name into namespace
<span class="cstat-no" title="statement not covered" >    methodAry = req.method.split('.');</span>
<span class="cstat-no" title="statement not covered" >    methodName = methodAry.pop();</span>
&nbsp;
    // Get the correct module from the API Tree    
<span class="cstat-no" title="statement not covered" >    file = getBranchFromTree(api, methodAry);</span>
<span class="cstat-no" title="statement not covered" >    if (!file) {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('Unable to find \'' + req.method + '\' file');</span>
    }
<span class="cstat-no" title="statement not covered" >    if (!file.actions) {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('Unable to find an \'exports.actions\' function for \'' + req.method + '\'');</span>
    }
<span class="cstat-no" title="statement not covered" >    if (typeof file.actions !== 'function') {</span>
<span class="cstat-no" title="statement not covered" >      throw new Error('\'exports.actions\' function for \'' + req.method + '\' must be a function');</span>
    }
&nbsp;
    // Create callback to send to interface    
<span class="cstat-no" title="statement not covered" >    cb = <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >      var args;</span>
<span class="cstat-no" title="statement not covered" >      args = Array.prototype.slice.call(arguments);</span>
<span class="cstat-no" title="statement not covered" >      return res(null, args);</span>
    };
&nbsp;
    // Get hold of available actions and populate middleware    
<span class="cstat-no" title="statement not covered" >    actions = file.actions(req, cb, ss);</span>
&nbsp;
    // Execute method at the end of the stack    
<span class="cstat-no" title="statement not covered" >    main = <span class="fstat-no" title="function not covered" >function() {</span></span>
      // Find the action we're calling
<span class="cstat-no" title="statement not covered" >      var method;</span>
<span class="cstat-no" title="statement not covered" >      method = actions[methodName];</span>
&nbsp;
      // Warn if this action doesn't exist      
<span class="cstat-no" title="statement not covered" >      if (method == null) {</span>
<span class="cstat-no" title="statement not covered" >        return res(new Error('Unable to find \'' + req.method + '\' method in exports.actions'));</span>
      }
<span class="cstat-no" title="statement not covered" >      if (typeof method !== 'function') {</span>
<span class="cstat-no" title="statement not covered" >        return res(new Error('The \'' + req.method + '\' method in exports.actions must be a function'));</span>
      }
&nbsp;
      // Execute action      
<span class="cstat-no" title="statement not covered" >      return method.apply(actions, req.params);</span>
    };
&nbsp;
    // Add RPC call to bottom of middleware stack    
<span class="cstat-no" title="statement not covered" >    stack.push(main);</span>
<span class="cstat-no" title="statement not covered" >    exec = <span class="fstat-no" title="function not covered" >function(request, res, i) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (i == null) {</span>
<span class="cstat-no" title="statement not covered" >        i = 0;</span>
      }
<span class="cstat-no" title="statement not covered" >      return stack[i].call(stack, req, res, <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >        return exec(req, res, i + 1);</span>
      });
    };
&nbsp;
    // Execute stack    
<span class="cstat-no" title="statement not covered" >    return exec(req, cb);</span>
  });
};
&nbsp;
&nbsp;
// Private
&nbsp;
getBranchFromTree = <span class="fstat-no" title="function not covered" >function getBranchFromTree(tree, ary, index, i) {</span>
<span class="cstat-no" title="statement not covered" >  if (index == null) {</span>
<span class="cstat-no" title="statement not covered" >    index = null;</span>
  }
<span class="cstat-no" title="statement not covered" >  if (i == null) {</span>
<span class="cstat-no" title="statement not covered" >    i = 0;</span>
  }
<span class="cstat-no" title="statement not covered" >  if (index == null) {</span>
<span class="cstat-no" title="statement not covered" >    index = ary.length;</span>
  }
<span class="cstat-no" title="statement not covered" >  if (i === index) {</span>
<span class="cstat-no" title="statement not covered" >    return tree;</span>
  }
<span class="cstat-no" title="statement not covered" >  return getBranchFromTree(tree[ary[i]], ary, index, ++i);</span>
};
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Jun 14 2015 21:28:00 GMT+0200 (CEST)</div>
</div>
<script src="../../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../../sorter.js"></script>
</body>
</html>
