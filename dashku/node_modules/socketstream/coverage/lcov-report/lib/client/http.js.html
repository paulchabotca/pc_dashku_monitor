<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/client/http.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">lib/client/http.js</span></h1>
    <h2>
        Statements: <span class="metric">40% <small>(14 / 35)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">0% <small>(0 / 10)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">33.33% <small>(1 / 3)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">40% <small>(14 / 35)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">lib/client/</a> &#187; http.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// Serve Views
// -----------
// Extend Node's HTTP http.ServerResponse object to serve views either from a cache (in production)
// or by generating them on-the-fly (in development)
// Note: Even though this is exactly what Express.js does, it's not best practice to extend Node's native
// objects and we don't be doing this in SocketStream 0.4
'use strict';
&nbsp;
var cache, fs, http, pathlib, res, view, log;
&nbsp;
require('colors');
&nbsp;
fs = require('fs');
&nbsp;
pathlib = require('path');
&nbsp;
http = require('http');
&nbsp;
view = require('./view');
&nbsp;
log = require('../utils/log');
&nbsp;
// Cache each view in RAM when packing assets (i.e. production mode)
cache = {};
&nbsp;
// Get hold of the 'response' object so we can extend it later
res = http.ServerResponse.prototype;
&nbsp;
module.exports = function(ss, clients, options) {
&nbsp;
  // Append the 'serveClient' method to the HTTP Response object  
  res.serveClient = <span class="fstat-no" title="function not covered" >function(name) {</span>
<span class="cstat-no" title="statement not covered" >    var self = this;</span>
&nbsp;
<span class="fstat-no" title="function not covered" >    function sendHTML(html, code) {</span>
<span class="cstat-no" title="statement not covered" >      if (!code) {</span>
<span class="cstat-no" title="statement not covered" >        code = 200;</span>
      }
      /*
        self.writeHead(code, header) removed to allow connect.compress() perform static HTML files compression.
        Before it was work only for static asserts because of response header overwriting.
        Instead we do set response status and header with two separate methods  self.statusCode and self.setHeader(name, value);
       */
<span class="cstat-no" title="statement not covered" >      self.statusCode = code;</span>
<span class="cstat-no" title="statement not covered" >      self.setHeader('Content-Length', Buffer.byteLength(html));</span>
<span class="cstat-no" title="statement not covered" >      self.setHeader('Content-Type', 'text/html; charset=UTF-8');</span>
<span class="cstat-no" title="statement not covered" >      self.end(html);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      var client = typeof name === 'string' &amp;&amp; clients[name];</span>
<span class="cstat-no" title="statement not covered" >      if (!client) {</span>
<span class="cstat-no" title="statement not covered" >        throw new Error('Unable to find single-page client: ' + name);</span>
      }
&nbsp;
      // Load packed HTML file      
<span class="cstat-no" title="statement not covered" >      if (options.packedAssets) {</span>
&nbsp;
        // Return from in-memory cache if possible        
<span class="cstat-no" title="statement not covered" >        if (!cache[name]) {</span>
<span class="cstat-no" title="statement not covered" >          var fileName = pathlib.join(ss.root, options.dirs.assets, client.name, client.id + '.html');</span>
<span class="cstat-no" title="statement not covered" >          cache[name] = fs.readFileSync(fileName, 'utf8');</span>
        }
&nbsp;
        // Send to browser
<span class="cstat-no" title="statement not covered" >        return sendHTML(cache[name]);</span>
      } else {
        //Â Generate View from scratch in development         
<span class="cstat-no" title="statement not covered" >        return view(ss, client, options, sendHTML);</span>
      }
    } catch (e) {
      // Never send stack trace to the browser, log it to the terminal instead      
<span class="cstat-no" title="statement not covered" >      sendHTML('Internal Server Error', 500);</span>
<span class="cstat-no" title="statement not covered" >      log.error('Error: Unable to serve HTML!'.red);</span>
<span class="cstat-no" title="statement not covered" >      log.debug(e.stack);</span>
<span class="cstat-no" title="statement not covered" >      return log.error(e);</span>
    }
  };
&nbsp;
  // Alias res.serveClient to keep compatibility with existing apps  
  res.serve = res.serveClient;
  return res.serve;
};
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Jun 14 2015 21:28:00 GMT+0200 (CEST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
